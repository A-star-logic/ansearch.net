---
export const prerender = false;
import LayoutDefault from '@layouts/LayoutDefault.astro';
import ContentVertical from '@components/position/ContentVertical.astro';
import Sidebar from '@components/single-use/blogsidebar.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { getLangFromUrl } from '@/i18n/utilities';

const lang = getLangFromUrl(Astro.url);
const getTitle = (lang: string) => {
  switch (lang) {
    case 'fr':
      return 'Liste des articles';
    default:
      return 'Articles archive';
  }
};

const posts: CollectionEntry<'blog'>[] = (await getCollection('blog')).filter(
  (p: CollectionEntry<'blog'>) => p.data.lang === lang,
);
const categories = [...new Set(posts.flatMap((p) => p.data.categories))];
const tags = [...new Set(posts.flatMap((p) => p.data.tags || []))];

const url = new URL(Astro.url);
const activeCategory = url.searchParams.get('category');
const activeTags = url.searchParams.get('tag')?.split('-') || null;

const filteredPosts = posts.filter((post) => {
  if (activeCategory && !post.data.categories.includes(activeCategory))
    return false;
  if (activeTags && activeTags.every((tag) => !post.data.tags.includes(tag)))
    return false;
  return true;
});
---

<LayoutDefault>
  <div class="blog-container">
    <Sidebar {categories} {tags} />
    <ContentVertical>
      <h1>Blog</h1>
      <h2>{getTitle(lang)}</h2>
      <ul>
        {
          filteredPosts.map((post) => (
            <li>
              <a href={`blog/${post.slug}`}>{post.data.title}</a>
            </li>
          ))
        }
      </ul>
    </ContentVertical>
  </div>
</LayoutDefault>

<style>
  .blog-container {
    display: flex;

    .flex-vertical {
      width: 100%;
    }
  }
</style>
